!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.flyd=e()}(this,function(){"use strict";var n=Array.prototype.slice,e=Array.prototype.concat;function t(r,u){return function(){var a=n.call(arguments);return a.length>=r?u.apply(null,a):t(r-a.length,function(){return u.apply(null,e.call(a,n.call(arguments)))})}}function r(){return!0}var u,a=[],o=[],s=-1,d=!1,i=!1;var f={};function c(n,e){var t,u,a,o,s=V([],r);for(a=[],o=[],t=0;t<e.length;++t)void 0!==e[t]&&(a.push(e[t]),void 0!==e[t].end&&o.push(e[t].end));return(u=V(a,n)).depsChanged=[],u.fnArgs=u.deps.concat([u,u.depsChanged]),u.end=s,s.listeners.push(u),x(o,s),s.deps=o,M(u),u}function l(n,e){return c(function(e,t){t(n(e.val))},[e])}function p(n){return l(n,this)}function h(n){return n(this)}function v(n){return g(n,this)}function g(n,e){var t=f.stream(1),r=f.on(function(){var n=t()-1;t(n),n<=0&&t.end(!0)});r(e.end);var u=f.stream(),a=f.combine(function(e,a){u.end(!0);var o=n(e());t(t()+1),r(o.end),u=l(a,o)},[e]);return f.endsOn(t.end,a),a}function m(n,e){return c(function(n,e,t){t(n.val(e.val))},[e,n])}function y(n){return m(n,this)}function C(n){return m(this,n)}function U(){return"stream("+this.val+")"}function A(){function n(e){return 0===arguments.length?n.val:(function n(e,t){t.val=e;t.hasVal=!0;void 0===u?(i=!0,function(n){var e,t,r,u=n.listeners;for(e=0;e<u.length;++e)(r=u[e]).end===n?P(r):(void 0!==r.depsChanged&&r.depsChanged.push(n),r.shouldUpdate=!0,O(r));for(;s>=0;--s)!0===(t=o[s]).shouldUpdate&&M(t),t.queued=!1}(t),a.length>0&&b(),i=!1):u===t?function(n,e){var t,r;for(t=0;t<e.length;++t)(r=e[t]).end!==n?(void 0!==r.depsChanged&&r.depsChanged.push(n),r.shouldUpdate=!0):P(r)}(t,t.listeners):q(function(t){n(e,t)},t)}(e,n),n)}return n.hasVal=!1,n.val=void 0,n.updaters=[],n.listeners=[],n.queued=!1,n.end=void 0,n.ap=y,n["fantasy-land/map"]=n.map=p,n["fantasy-land/ap"]=C,n["fantasy-land/of"]=n.of=f.stream,n["fantasy-land/chain"]=n.chain=v,n.pipe=h,n.constructor=f.stream,n.toJSON=function(){return n.val},n.toString=U,n}function V(n,e){var t=A();return t.fn=e,t.deps=n,t.depsMet=!1,t.depsChanged=n.length>0?[]:void 0,t.shouldUpdate=!1,x(n,t),t}function M(n){var e;if((!(e=n).end||!0!==e.end.val)&&function(n){return!0===n.depsMet||function(n){return n.depsMet=n.deps.every(function(n){return n.hasVal}),n.depsMet}(n)}(n))if(void 0===u){u=n,n.depsChanged&&(n.fnArgs[n.fnArgs.length-1]=n.depsChanged);var t=n.fn.apply(n.fn,n.fnArgs);void 0!==t&&n(t),u=void 0,void 0!==n.depsChanged&&(n.depsChanged=[]),n.shouldUpdate=!1,!1===(d||i)&&b(),function(n){return n.listeners.some(function(n){return n.shouldUpdate})}(n)&&(i?n.listeners.forEach(function(n){n.shouldUpdate&&q(M,n)}):n(n.val))}else q(M,n)}function O(n){var e,t=n.listeners;if(!1===n.queued){for(n.queued=!0,e=0;e<t.length;++e)O(t[e]);o[++s]=n}}function q(n,e){a.push(e),e.updaters.push(n),e.shouldUpdate=!0}function b(){for(d=!0;a.length>0;){var n=a.shift(),e=n.updaters.shift();e&&n.shouldUpdate&&e(n)}d=!1}function x(n,e){for(var t=0;t<n.length;++t)n[t].listeners.push(e)}function S(n,e){e[e.indexOf(n)]=e[e.length-1],e.length--}function N(n){for(var e=0;e<n.deps.length;++e)S(n,n.deps[e].listeners);n.deps.length=0}function P(n){void 0!==n.deps&&N(n),void 0!==n.end&&N(n.end)}function j(){}return f.stream=function(n){var e=V([],r),t=A();return t.end=e,t.fnArgs=[],e.listeners.push(t),arguments.length>0&&t(n),t},f.stream["fantasy-land/of"]=f.stream.of=f.stream,f.combine=t(2,c),f.isStream=function(n){return!!((e=n)&&e.constructor&&e.call&&e.apply)&&"hasVal"in n;var e},f.immediate=function(n){return!1===n.depsMet&&(n.depsMet=!0,M(n)),n},f.endsOn=function(n,e){return N(e.end),n.listeners.push(e.end),e.end.deps.push(n),e},f.map=t(2,l),f.chain=t(2,g),f.ap=t(2,m),f.on=t(2,function(n,e){return c(function(e){n(e.val)},[e])}),f.scan=t(3,function(n,e,t){var r=c(function(t,r){r(e=n(e,t.val))},[t]);return r.hasVal||r(e),r}),f.merge=t(2,function(n,e){var t=f.immediate(c(function(n,e,t,r){r[0]?t(r[0]()):n.hasVal?t(n.val):e.hasVal&&t(e.val)},[n,e]));return f.endsOn(c(function(){return!0},[n.end,e.end]),t),t}),f.transduce=t(2,function(n,e){return n=n(new j),c(function(e,t){var r=n["@@transducer/step"](void 0,e.val);return r&&!0===r["@@transducer/reduced"]?(t.end(!0),r["@@transducer/value"]):r},[e])}),f.curryN=t,f.curry=function(n){return t(n.length,n)},f.fromPromise=function(n){var e=f.stream();return n.then(function(n){e(n),e.end(!0)}),e},f.flattenPromise=function(n){return c(function(n,e){n().then(e)},[n])},j.prototype["@@transducer/init"]=function(){},j.prototype["@@transducer/result"]=function(){},j.prototype["@@transducer/step"]=function(n,e){return e},f});
